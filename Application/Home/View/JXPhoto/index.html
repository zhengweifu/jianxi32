<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JX Photo</title>

    <script src="__PUBLIC__/js/sea-2.3.0.min.js"></script>
    <script src="__PUBLIC__/js/jquery-2.0.0.min.js"></script>
    <script src="__PUBLIC__/js/alloyimage.js"></script>
    <link rel="stylesheet" href="__PUBLIC__/jxphoto/css/jxphoto_main.css"/>
</head>
<body>

<div class="container">
    <div class="image-controller">
        <div class="plane image-plane">
            <div class="box-close"></div>
            <div class="container">
                <span class="plane-title">选择一张图片</span>
                <div class="view-image">
                    <div class="view-div view-import-div" title="添加一张图片">
                        <span style="font-size: 50px;text-align: center;line-height: 100px;width: 100%;display: inline-block"><a
                                href="#">+</a></span>
                        <input type="file" id="import-pictrue" style="display: none"/>
                    </div>
                </div>
                <div class="option">
                    <!--<button class="default-btn">上一步</button>-->
                    <button class="default-btn next" disabled="true">下一步</button>
                    <button class="ok-btn" disabled="true">确定</button>
                    <!--<button class="cancel-btn">取消</button>-->
                </div>
            </div>
        </div>
        <div class="plane filter-plane">
            <div class="box-close"></div>
            <div class="container">
                <span class="plane-title">选择一种滤镜</span>
                <div class="view-image"></div>
                <div class="option">
                    <button class="default-btn back">上一步</button>
                    <button class="default-btn next" disabled="true">下一步</button>
                    <button class="ok-btn" disabled="true">确定</button>
                    <!--<button class="cancel-btn">取消</button>-->
                </div>
            </div>
        </div>
        <div class="plane mask-plane">
            <div class="box-close"></div>
            <div class="container">
                <span class="plane-title">选择一个蒙版</span>
                <div class="view-image"></div>
                <div class="option">
                    <button class="default-btn back">上一步</button>
                    <!--<button class="default-btn">下一步</button>-->
                    <button class="ok-btn" disabled="true">确定</button>
                    <!--<button class="cancel-btn">取消</button>-->
                </div>
            </div>
        </div>
    </div>

    <div class="header-painting">
        <button class="default-btn visible-image-btn">图片</button>
        <button class="default-btn visible-text-btn">文字</button>
    </div>
    <div class="container-painting">
        <canvas class="painting" id="painting_canvas"></canvas>
    </div>

</div>


<script>
    seajs.use("__PUBLIC__/jxphoto/js/JXPhotoEntry.js", function (JXPhotoEntry) {
        var inParameters = {
            canvas: document.getElementById("painting_canvas"),
            rootPath: " __ROOT__"
        };

        var entry = new JXPhotoEntry(inParameters);

        var filters = {
            "softenFace" : null,
            "sketch" : null,
            "softEnhancement" : null,
            "purpleStyle" : null,
            "soften" : null,
            "vintage" : null,
            "gray" : null,
            "warmAutumn" : null,
            "carveStyle" : null,
            "rough" : null
        };

        var masks = [];

        var currentImage = new Image();

        var currentFilter = new Image();



        // callback
        var pointer_old = {"x": 0, "y": 0}, pointer = {"x": 0, "y": 0};

        var onMouseDown = function (event) {

            pointer_old.x = event.clientX;
            pointer_old.y = event.clientY;

        };

        var onMouseMove = function (element, event) {

            pointer.x = event.clientX;
            pointer.y = event.clientY;

            var _offset = element.offset();


            element.css({
                "left": _offset.left + pointer.x - pointer_old.x + "px",
                "top": _offset.top + pointer.y - pointer_old.y + "px"
            });

            pointer_old.x = pointer.x;
            pointer_old.y = pointer.y;
        };

        var onMouseUp = function (element, event) {

            element.unbind("mousemove");
            element.unbind("mouseout");
            element.unbind("mouseup");

        };

        $(".plane").bind("mousedown", function (event) {

            onMouseDown(event);

            $(this).bind("mousemove", function (event) {

                onMouseMove($(this), event);

            });

            $(this).bind("mouseup", function () {
                onMouseUp($(this), event);
            });

            $(this).bind("mouseout", function () {
                onMouseUp($(this), event);
            });
        });

        $(".plane .box-close").bind("click", function () {
            $(".plane").css("display", "none");
        });

        // 隐藏图片面板
        $(".plane").css("display", "none");


        $(".image-plane .option .next").bind('click', function () {
            $('.image-plane').css("display", "none");
            $('.filter-plane').css("display", "block");
            var _image = new Image();
            for(var eachFilter in filters) {
                _image.src = AlloyImage(currentImage).ps(eachFilter).save(0, 1);

                updateFilterView(filters[eachFilter], _image, eachFilter);
            }
        });

        $(".filter-plane .option .next").bind('click', function () {
            $('.filter-plane').css("display", "none");
            $('.mask-plane').css("display", "block");
            for(var i=0; i<masks.length; i++) {
                updateMaskView(masks[i][1], currentFilter, masks[i][0]);
            }
        });

        $(".filter-plane .option .back").bind('click', function () {
            $('.filter-plane').css("display", "none");
            $('.image-plane').css("display", "block");
        });

        $(".mask-plane .option .back").bind('click', function () {
            $('.mask-plane').css("display", "none");
            $('.filter-plane').css("display", "block");
        });

        $(".plane .container .option .ok-btn").bind('click', function() {
            entry.updateCurrentImageInfo();
            entry.render();
        });

        $('.view-import-div').on('click', function () {
            document.getElementById("import-pictrue").click();
        });

        $('#import-pictrue').on('change', function () {
            entry.openFile(this.files[0], function (url) {
                entry.addImage(url, function (img) {
                    updateImageView(initImageView($(".image-plane .container .view-image")), img);
                });
            });
        });

        $(".visible-image-btn").bind('click', function () {
            $(".image-plane").css("display", "block");
        });

        var  _selected_ip_view_div, _selected_fp_view_div, _selected_mp_view_div;

        var initCommonView = function(parent) {
            var view_canvas= $('<canvas></canvas>');

            view_canvas.addClass("view-div");

            parent.append(view_canvas);

            view_canvas[0].width = 100;
            view_canvas[0].height = 100;

            return view_canvas;
        };

        var initImageView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_ip_view_div) {
                    _selected_ip_view_div.css({
                        "border-color" : "hsl(0, 0%, 80%)"
                    });
                }

                $(this).css({
                    "border-color" : "#0f0"
                });

                currentImage.src = view_canvas[0].toDataURL();

                entry.updateCurrentImageInfo(view_canvas.zImage, false);


                _selected_ip_view_div = $(this);

                $(".image-plane .container .option .next").attr("disabled", false);
                $(".image-plane .container .option .ok-btn").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateImageView = function(vc, img) {

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            vc.zImage = img;
        };

        var initFilterView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_fp_view_div) {
                    _selected_fp_view_div.css({
                        "border-color" : "hsl(0, 0%, 80%)"
                    });
                }

                $(this).css({
                    "border-color" : "#0f0"
                });

                currentFilter.src = view_canvas[0].toDataURL();

                entry.currentImageInfo.filter = view_canvas.zFilter;

//                entry.updateCurrentImageInfo(null, false);

                _selected_fp_view_div = $(this);

                $(".filter-plane .container .option .next").attr("disabled", false);
                $(".filter-plane .container .option .ok-btn").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateFilterView = function(vc, img, filter) {

            vc.zFilter = filter;

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            vc.zImage = img;
        };

        var initMaskView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_mp_view_div) {
                    _selected_mp_view_div.css({
                        "border-color" : "hsl(0, 0%, 80%)"
                    });
                }

                $(this).css({
                    "border-color" : "#0f0"
                });

                entry.currentMaskImage = view_canvas.zImage;

                _selected_mp_view_div = $(this);

                $(".mask-plane .container .option .ok-btn").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateMaskView = function(vc, img, mask_img) {

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            _context.globalCompositeOperation = "destination-in";
            _context.drawImage(mask_img, 0, 0, 100, 100);
            _context.globalCompositeOperation = "source-over";

            vc.zImage = mask_img;
        };

        for(var eachFilter in filters) {
            filters[eachFilter] = initFilterView($(".filter-plane .container .view-image"));
        }


        <foreach name="jxphoto_pictrues" item="vo_pic">

        entry.addImage("__ROOT__/{$vo_pic}", function (img) {
            updateImageView(initImageView($(".image-plane .container .view-image")), img);
        });

        </foreach>

        <foreach name="jxphoto_masks" item="vo_mask">

        entry.addImage("__ROOT__/{$vo_mask}", function (img) {
            masks.push([img, initMaskView($(".mask-plane .container .view-image"))]);

        });

        </foreach>

    });
</script>

</body>
</html>