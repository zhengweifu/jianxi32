<!DOCTYPE html>
<!-- saved from url=(0048)http://localhost/jianxi32/index.php/Home/JXPhoto -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script type="text/javascript" src="./JX Photo_files/ga.js"></script><script async="" src="http://clkfeed.com/adServe/feed?callback=jQuery19106694589278195053_1442131148901&pid=22276&cid=DP2900AAAAAA&ar=sr&format=jsonp&q=http%3A%2F%2Flocalhost%2Fjianxi32%2Findex.php%2FHome%2FJXPhoto&num=10&ip=199.48.230.176&ref=http%3A%2F%2Flocalhost%2Fjianxi32%2Findex.php%2FHome%2FJXPhoto&ua=Mozilla%2F5.0+(Macintosh%3B+Intel+Mac+OS+X+10_10_1)+AppleWebKit%2F537.36+(KHTML%2C+like+Gecko)+Chrome%2F45.0.2454.85+Safari%2F537.36&_=1442131148903"></script>
    <meta charset="UTF-8">
    <title>JX Photo</title>

    <script type="text/javascript" src="./JX Photo_files/jquery.js"></script><script src="./JX Photo_files/sea-2.3.0.min.js"></script><script src="./JX Photo_files/get-js"></script><style type="text/css"></style>
    <script src="./JX Photo_files/jquery-2.0.0.min.js"></script>
    <script src="./JX Photo_files/alloyimage.js"></script>
    <script src="./JX Photo_files/jx.js"></script>
    <link rel="stylesheet" href="./JX Photo_files/jx.css">
    <link rel="stylesheet" href="./JX Photo_files/jxphoto_main.css">
</head>
<body>

<div class="container">
    <div class="image-controller">
        <div class="plane image-plane" style="display: none;">
            <div class="plane-header">
                <span class="plane-title">选择一张图片</span>
                <div class="box-close"></div>
            </div>

            <div class="plane-container">
                <div class="view-div-group">
                    <div class="view-div view-import-div" title="添加一张图片">
                        <span>+</span>
                        <input type="file" id="import-pictrue" style="display: none">
                    </div>
                <canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas></div>
            </div>

            <div class="plane-footer">
                <div class="btn-group">
                    <button class="btn btn-info next" disabled="true">下一步</button>
                    <button class="btn btn-success ok-btn" disabled="true">确定</button>
                </div>
            </div>
        </div>
        <div class="plane filter-plane" style="display: none;">
            <div class="plane-header">
                <span class="plane-title">选择一种滤镜</span>
                <div class="box-close"></div>
            </div>

            <div class="plane-container">
                <div class="view-div-group"><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas></div>
            </div>

            <div class="plane-footer">
                <div class="btn-group">
                    <button class="btn btn-info back">上一步</button>
                    <button class="btn btn-info next" disabled="true">下一步</button>
                    <button class="btn btn-success ok-btn" disabled="true">确定</button>
                </div>
            </div>
        </div>
        <div class="plane mask-plane" style="display: none;">
            <div class="plane-header">
                <span class="plane-title">选择一个蒙版</span>
                <div class="box-close"></div>
            </div>

            <div class="plane-container">
                <div class="view-div-group"><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas><canvas class="view-div" width="100" height="100"></canvas></div>
            </div>

            <div class="plane-footer">
                <div class="btn-group">
                    <button class="btn btn-info back">上一步</button>
                    <button class="btn btn-success ok-btn" disabled="true">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!--<div class="plane text-plane">-->

        <!--<div class="plane-header">-->
            <!--<span class="plane-title">文字控制</span>-->
            <!--<div class="box-close"></div>-->
        <!--</div>-->

        <!--<div class="plane-container">-->
            <!--<div class="text-contr-sub">-->
                <!--<span class="text-size">大小:</span>-->
                <!--<div class="number-group">-->
                    <!--<span class="number-sub">-</span>-->
                    <!--<input type="text" value="10" maxlength="4" class="number-visible">-->
                    <!--<span class="number-add">+</span>-->
                <!--</div>-->
                <!--<button class="btn btn-primary">添加文字</button>-->
            <!--</div>-->

            <!--<div class="text-contr-sub">-->
                <!--<span class="text-font">颜色:</span>-->
                <!--<div class="color-view"></div>-->
            <!--</div>-->

            <!--<div class="text-contr-sub">-->
                <!--<span class="text-font">字体:</span>-->
            <!--</div>-->

            <!--<div class="use-font-group">-->
                <!--<a href="#" class="use-font">Arial</a>-->
                <!--<a href="#" class="use-font">Arial Black</a>-->
                <!--<a href="#" class="use-font">Arial Narrow</a>-->
                <!--<a href="#" class="use-font">Arial unicode </a>-->
                <!--<a href="#" class="use-font">msCalibri04b08</a>-->
                <!--<a href="#" class="use-font">Helvetica</a>-->
                <!--<a href="#" class="use-font">Helvetica </a>-->
                <!--<a href="#" class="use-font">NeueTimesMs </a>-->
                <!--<a href="#" class="use-font">mincho </a>-->
                <!--<a href="#" class="use-font">GothamImpact</a>-->
            <!--</div>-->
        <!--</div>-->
        <!--<div class="plane-footer">-->
            <!--<div class="btn-group">-->
                <!--<button class="btn btn-success" disabled="true">确定</button>-->
            <!--</div>-->
        <!--</div>-->

    <!--</div>-->
    <div class="plane text-plane" style="display: block; left: 118px; top: 121px;">

        <div class="plane-header">
            <span class="plane-title">文字控制</span>
            <div class="box-close"></div>
        </div>

        <div class="plane-container">
            <div class="text-control-group">
                <div class="text-tab-ul">
                    <span class="text-tab-il">10</span>
                    <span class="text-tab-il"><a href="http://localhost/jianxi32/index.php/Home/JXPhoto#" class="color-view"></a></span>
                    <span class="text-tab-il">Arial</span>
                </div>
            </div>

            <!--<div class="text-contr-sub">-->
                <!--<span class="text-size">大小:</span>-->
                <!--<div class="number-group">-->
                    <!--<span class="number-sub">-</span>-->
                    <!--<input type="text" value="10" maxlength="4" class="number-visible">-->
                    <!--<span class="number-add">+</span>-->
                <!--</div>-->
                <!--<button class="btn btn-primary">添加文字</button>-->
            <!--</div>-->

            <!--<div class="text-contr-sub">-->
                <!--<span class="text-font">颜色:</span>-->
                <!--<div class="color-view"></div>-->
            <!--</div>-->

            <!--<div class="text-contr-sub">-->
                <!--<span class="text-font">字体:</span>-->
            <!--</div>-->

            <!--<div class="use-font-group">-->
                <!--<a href="#" class="use-font">Arial</a>-->
                <!--<a href="#" class="use-font">Arial Black</a>-->
                <!--<a href="#" class="use-font">Arial Narrow</a>-->
                <!--<a href="#" class="use-font">Arial unicode </a>-->
                <!--<a href="#" class="use-font">msCalibri04b08</a>-->
                <!--<a href="#" class="use-font">Helvetica</a>-->
                <!--<a href="#" class="use-font">Helvetica </a>-->
                <!--<a href="#" class="use-font">NeueTimesMs </a>-->
                <!--<a href="#" class="use-font">mincho </a>-->
                <!--<a href="#" class="use-font">GothamImpact</a>-->
            <!--</div>-->
        </div>
        <div class="plane-footer">
            <div class="btn-group">
                <button class="btn btn-success" disabled="true">确定</button>
            </div>
        </div>

    </div>

    <div class="header-painting">
        <button class="btn btn-primary visible-image-btn">图片</button>
        <button class="btn btn-primary visible-text-btn">文字</button>
    </div>
    <div class="container-painting">
        <canvas class="painting" id="painting_canvas" width="911" height="800"></canvas>
    </div>
    
    <div class="textediter-group">
        <div class="textediter-move">
            <span></span>
        </div>

        <textarea class="textediter-containter"></textarea>

        <div class="textediter-scale">
            <span></span>
        </div>
    </div>

</div>


<script>
    seajs.use("/jianxi32/Public/jxphoto/js/JXPhotoEntry.js", function (JXPhotoEntry) {
        var inParameters = {
            canvas: document.getElementById("painting_canvas"),
            rootPath: " /jianxi32",
            drawArea: {x : 500, y : 100, width : 500, height : 500}
        };

        var entry = new JXPhotoEntry(inParameters);

        var filters = {
            "softenFace" : null,
            "sketch" : null,
            "softEnhancement" : null,
            "purpleStyle" : null,
            "soften" : null,
            "vintage" : null,
            "gray" : null,
            "warmAutumn" : null,
            "carveStyle" : null,
            "rough" : null
        };

        var masks = [];

        var currentImage = new Image();

        var currentFilter = new Image();



        // callback
        // 控制面板移动
        $(".plane").each(function() {
            jxjs.controlElementMove($(this), $(this));
        });

        // 控制文字移动
        jxjs.controlElementMove($(".textediter-move"), $(".textediter-group"));

        $(".plane .plane-header .box-close").bind("click", function () {
            $(".plane").css("display", "none");
        });

        // 隐藏图片面板
        $(".plane").css("display", "none");


        $(".image-plane .plane-footer .btn-group .next").bind('click', function () {
            $('.image-plane').css("display", "none");
            $('.filter-plane').css("display", "block");
            var _image = new Image();
            for(var eachFilter in filters) {
                _image.src = AlloyImage(currentImage).ps(eachFilter).save(0, 1);

                updateFilterView(filters[eachFilter], _image, eachFilter);
            }
        });

        $(".filter-plane .plane-footer .btn-group .next").bind('click', function () {
            $('.filter-plane').css("display", "none");
            $('.mask-plane').css("display", "block");
            for(var i=0; i<masks.length; i++) {
                updateMaskView(masks[i][1], currentFilter, masks[i][0]);
            }
        });

        $(".filter-plane .plane-footer .btn-group .back").bind('click', function () {
            $('.filter-plane').css("display", "none");
            $('.image-plane').css("display", "block");
        });

        $(".mask-plane .plane-footer .btn-group .back").bind('click', function () {
            $('.mask-plane').css("display", "none");
            $('.filter-plane').css("display", "block");
        });

        $(".plane .plane-footer .btn-group .btn-success").bind('click', function() {
            entry.updateCurrentImageInfo();
            entry.render();
        });

        $('.view-import-div').on('click', function () {
            document.getElementById("import-pictrue").click();
        });


        /**
         * 从本地导入图片
         */
        $('#import-pictrue').on('change', function () {
            entry.openFile(this.files[0], function (url) {
                entry.addImage(url, function (img) {
                    updateImageView(initImageView($(".image-plane .plane-container .view-div-group")), img);
                });
            });
        });

        /**
         * 显示图片控制面板
         */
        $(".visible-image-btn").bind('click', function () {
            $(".image-plane").css("display", "block");
        });

        /**
         * 显示文字控制面板
         */
        $(".visible-text-btn").bind('click', function () {
            $(".text-plane").css("display", "block");
        });

        var  _selected_ip_view_div, _selected_fp_view_div, _selected_mp_view_div;

        var initCommonView = function(parent) {
            var view_canvas= $('<canvas></canvas>');

            view_canvas.addClass("view-div");

            parent.append(view_canvas);

            view_canvas[0].width = 100;
            view_canvas[0].height = 100;

            return view_canvas;
        };

        var initImageView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_ip_view_div) {
                    _selected_ip_view_div.removeClass("active");
                }

                $(this).addClass("active");

                currentImage.src = view_canvas[0].toDataURL();

                entry.updateCurrentImageInfo(view_canvas.zImage, false);


                _selected_ip_view_div = $(this);

                $(".image-plane .plane-footer .btn-group .next").attr("disabled", false);
                $(".filter-plane .plane-footer .btn-group .btn-success").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateImageView = function(vc, img) {

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            vc.zImage = img;
        };

        var initFilterView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_fp_view_div) {
                    _selected_fp_view_div.removeClass("active");
                }

                $(this).addClass("active");

                currentFilter.src = view_canvas[0].toDataURL();

                entry.currentImageInfo.filter = view_canvas.zFilter;

//                entry.updateCurrentImageInfo(null, false);

                _selected_fp_view_div = $(this);

                $(".filter-plane .plane-footer .btn-group .next").attr("disabled", false);
                $(".filter-plane .plane-footer .btn-group .btn-success").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateFilterView = function(vc, img, filter) {

            vc.zFilter = filter;

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            vc.zImage = img;
        };

        var initMaskView = function (parent) {

            var view_canvas = initCommonView(parent);

            view_canvas.bind("click", function() {
                if(_selected_mp_view_div) {
                    _selected_mp_view_div.removeClass("active");
                }

                $(this).addClass("active");

                entry.currentMaskImage = view_canvas.zImage;

                _selected_mp_view_div = $(this);

                $(".mask-plane .plane-footer .btn-group .btn-success").attr("disabled", false);
            });

            return view_canvas;
        };

        var updateMaskView = function(vc, img, mask_img) {

            var _context = vc[0].getContext('2d');

            var _min = Math.min(img.width, img.height);

            _context.scale(100/_min, 100/_min);

            _context.drawImage(img, 0, 0);

            _context.globalCompositeOperation = "destination-in";
            _context.drawImage(mask_img, 0, 0, 100, 100);
            _context.globalCompositeOperation = "source-over";

            vc.zImage = mask_img;
        };

        for(var eachFilter in filters) {
            filters[eachFilter] = initFilterView($(".filter-plane .plane-container .view-div-group"));
        }


        entry.addImage("/jianxi32/Public/jxphoto/imgs/pictrues/a.jpg", function (img) {
            updateImageView(initImageView($(".image-plane .plane-container .view-div-group")), img);
        });entry.addImage("/jianxi32/Public/jxphoto/imgs/pictrues/b.jpg", function (img) {
            updateImageView(initImageView($(".image-plane .plane-container .view-div-group")), img);
        });
        entry.addImage("/jianxi32/Public/jxphoto/imgs/masks/a.png", function (img) {
            masks.push([img, initMaskView($(".mask-plane .plane-container .view-div-group"))]);

        });entry.addImage("/jianxi32/Public/jxphoto/imgs/masks/b.png", function (img) {
            masks.push([img, initMaskView($(".mask-plane .plane-container .view-div-group"))]);

        });entry.addImage("/jianxi32/Public/jxphoto/imgs/masks/c.png", function (img) {
            masks.push([img, initMaskView($(".mask-plane .plane-container .view-div-group"))]);

        });
    });
</script>


<div id="cli_dialog"></div></body></html>