Array.prototype.del=function(t){t.sort(function(t,r){return t-r});for(var r=this.concat([]),a=t.length-1;a>=0;a--)r=r.slice(0,t[a]).concat(r.slice(t[a]+1));return r};try{HTMLImageElement.prototype.loadOnce=function(t){var r=0;this.onload=function(){r||t.call(this,null),r++}}}catch(e){window={}}!function(t){function r(){this.readyState&&(this.readyState=0,this.dorsyWorker.startWorker())}var a=function(){if(window.navigator){var t=window.navigator.userAgent;return/Android|android/.test(t)?"android":/iPhone|iPad|iPod/.test(t)?"ios":"other"}return"sandBox"}(),e={lib:[],definedPs:{},init:function(){this.require("config")},module:function(t,r){function a(t){n++;var o=e[n];return n==e.length-1?void(t[o]=r.call(null,i)):void a(t[o]?t[o]:t[o]={})}var e=[t];/\./g.test(t)&&(e=t.split("."));var n=-1,i=this;a(this.lib)},require:function(t){var r=this,a=document.createElement("script");document.body.appendChild(a),a.src="./js/module/"+t+".js",a.onload=a.onerror=function(t){r.handlerror(t)}},handlerror:function(t){},destroySelf:function(r){delete window[t];var a=new Error(r);throw a},reflect:function(t,r,a){var e=this.lib.config.getModuleName(t),n=e.spaceName,i=e.actName;switch(n){case"Filter":case"Alteration":return this.lib[n][i].process(r,a);case"ComEffect":return this.lib[i].process(r,a);default:this.destroySelf("AI_ERROR: ")}},reflectEasy:function(t){var r=this.lib.config.getEasyFun(t).actName;return this.definedPs[t]||this.lib.easy.getFun(r)},add:function(t,r,a,e,n,i,o,s){return this.lib.addLayer.add(t,r,a,e,n,i,o,s)},worker:function(t,r){},applyMatrix:function(t,r){},tools:function(t,r){var a=Array.prototype.shift.call(r);if(this.lib.Tools[a])return this.lib.Tools[a].process(t,r);throw new Error("AI_ERROR: 不存在的工具方法_"+a)},definePs:function(t,r){this.definedPs[t]=r}};window[t]=function(r,n,i){var o=this;if(!(this instanceof window[t]))return new window[t](r,n,i);this.startTime=+new Date;var s=document.createElement("canvas"),h=s.getContext("2d");if(isNaN(r))if("string"==typeof r){var c=new Image;c.onload=function(){s.width=parseInt(this.width),s.height=parseInt(this.height),h.drawImage(this,0,0,this.width,this.height)},c.src=r}else{var u=n,f=i,d=r.width,l=r.height,v=d/l;n||i?i?n||(u=f*v):f=~~(u/v):(u=d,f=l),s.width=u,s.height=f,isNaN(u)?h.drawImage(r,0,0):"ios"==a?e.lib.Fix.drawImageIOS(h,r,u,f):h.drawImage(r,0,0,u,f),this.srcImg=r}else s.width=r,s.height=n,i=i||"#fff",h.fillStyle=i,h.fillRect(0,0,r,n),this.srcImg="";this.canvas=s,this.context=h,this.imgData=h.getImageData(0,0,s.width,s.height),this.name=t+"_"+Math.random(),this.canvas.id=this.name,this.layers=[];var g=document.createElement("canvas");if(g.width=s.width,g.height=s.height,this.ctxCanvas=g,this.ctxContext=s.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.useWorker=e.useWorker,this.readyState=1,this.useWorker&&(this.dorsyWorker=e.lib.dorsyWorker(this)),e.lib.Tools)for(var p in e.lib.Tools)this.Tools[p]=function(t){return function(r){return o.Tools(t,r)}}(p)},window[t].module=function(t,r){e.module(t,r)},window[t].dorsyMath=function(){return e.lib.dorsyMath},window[t].setName=function(t){e.name=t||"alloyimage.js"},window[t].getConfig=function(){return e.lib.config.getConfig()},window[t].define=function(t,r){e.definePs(t,r)},window[t].useWorker=function(t){if(!window.Worker)return this.useWorker=0,void console.log("AI_WARNING: 浏览器不支持web worker, 自动切换为单线程\nAI_WARNING: the brower doesn't support Web Worker");var t=t||"";/[\/\\]$/.test(t)&&(t+=e.name),""==t&&(t="alloyimage.js"),e.useWorker=1,e.path=t;var r=new XMLHttpRequest;r.onreadystatechange=function(){4==r.readyState&&"404"==r.status&&e.destroySelf("AI_ERROR：使用worker时，ai文件路径指定错误\nAI_ERROR: error occured while using web worker since indicate the wrong path of file ai")},r.open("GET",t,!1),r.send()},onmessage=function(t){var r,a=t.data;"act"==a[0]?r=e.reflect(a[1],a[2],a[3]):"add"==a[0]&&(r=e.add.apply(e,a[1])),postMessage(r)},window[t].prototype={set width(t){this.canvas.width=t},set height(t){this.canvas.height=t},get width(){return this.canvas.width},get height(){return this.canvas.height},act:function(t,a){var n=[];return n=Array.prototype.slice.call(arguments,1),this.useWorker?(this.dorsyWorker.queue.push(["act",t,n]),r.call(this)):e.reflect(t,this.imgData,n),this},view:function(t,r,a,e,n){if(t){var i=this.layers.length;this.layers[i-1]&&1===this.layers[i-1][0].type&&this.cancel();for(var o,s=this.layers.length-1;s>-1;s--){var h=this.layers[s];if(2===h[0].type){o=h[0].clone();break}}o||(o=this.clone(),window.newLayer=o),"ps"===t?o=o.ps(r,a,e,n):o.act(t,r,a,e,n),o.type=1,this.addLayer(o,"正常",0,0)}else this.cancel();return this},doView:function(){var t=this.layers.length;return this.layers[t-1]&&2===this.layers[t-1][0].type?this:(this.layers[t-1]&&1===this.layers[t-1][0].type&&(this.layers[t-1][0].type=2),this)},undoView:function(){this.cancel();for(var t=this.layers.length-1;t>-1;t--){var r=this.layers[t];if(2===r[0].type){r[0].type=1;break}}return this},excute:function(){var t=this.layers,r=t.length;return t[r-1]&&1==t[r-1][0].type&&(this.imgData=t[r-1][0].imgData,delete t[r-1]),this},cancel:function(){var t=this.layers,r=t.length;return t[r-1]&&1==t[r-1][0].type&&t.pop(),this},complileLayers:function(r){if(0==this.layers.length)this.tempPsLib={imgData:this.imgData};else{var a=new window[t](this.canvas.width,this.canvas.height);a.add(this,"正常",0,0,r),this.tempPsLib=a;for(var e=0;e<this.layers.length;e++){var n=this.layers[e],i=n[0].layers,o=n[0];i[i.length-1]&&1==i[i.length-1][0].type&&(o=i[i.length-1][0]),a.add(o,n[1],n[2],n[3],r)}}},show:function(t,r,a){if(a);else if(this.useWorker)return this.dorsyWorker.queue.push(["show",t,r]),this;if(this.complileLayers(r),this.context.putImageData(this.tempPsLib.imgData,0,0),t)if("string"==typeof t){var e=document.querySelector(t);e.appendChild(this.canvas)}else t.appendChild(this.canvas);else document.body.appendChild(this.canvas);return this},replaceChild:function(t){var r;return r="string"==typeof t?document.querySelector(t):t,r.innerHTML="",this.show(r)},replace:function(t,a){if(a);else if(this.useWorker)return this.dorsyWorker.queue.push(["replace",t]),r.call(this),this;return t&&(t.onload=function(){},t.src=this.save(0,1,a)),this},add:function(){for(var t,a,n,i,o,s,h,c=[],u=0;u<arguments.length;u++)if(u)switch(typeof arguments[u]){case"string":/\d+%/.test(arguments[u])?n=arguments[u].replace("%",""):/[RGB]+/.test(arguments[u])?h=arguments[u]:a=arguments[u];break;case"number":c.push(arguments[u]);break;case"boolean":s=arguments[u]}return i=c[0]||0,o=c[1]||0,a=a||"正常",n=n/100||1,s=s||!1,h=h||"RGB",t=arguments[0],this.useWorker?(this.dorsyWorker.queue.push(["add",t,a,n,i,o,s,h]),r.call(this)):e.add(this.imgData,t.imgData,a,n,i,o,s,h),this},addLayer:function(t,r,a,e){return this.layers.push([t,r,a,e]),this},clone:function(r){var a=new window[t](this.canvas.width,this.canvas.height);return a.context.putImageData(this.imgData,0,0),a.imgData=a.context.getImageData(0,0,this.canvas.width,this.canvas.height),a},swap:function(t,r){var a=this.layers[t];return this.layers[t]=this.layers[r],this.layers[r]=a,this},deleteLayers:function(t){this.layers=this.layers.del(t)},save:function(t,a,e){t=t||"png",t=t.toLowerCase(),a=a||.8,"jpg"==t&&(t="jpeg");var n="image/"+t;if(e);else if(this.useWorker)return this.dorsyWorker.queue.push(["save"]),r.call(this),this;return this.complileLayers(),this.context.putImageData(this.tempPsLib.imgData,0,0),this.canvas.toDataURL(n,a)},saveFile:function(t,r){t=t||"AlloyImage合成图像.jpg",r=r||1;var a=/.*.(jpg|png|gif|jpeg)$/g,e="png";a.test(t)?(a.lastIndex=0,e=a.exec(t)[1]):t+=".png";var n=this.save(e,r),i=document.createElement("a");i.href=n,i.download=t;var o=document.createEvent("HTMLEvents");o.initEvent("click",!1,!1),i.dispatchEvent(o)},download:function(t,r){this.saveFile(t,r)},saveAsDataURL:function(){},saveAsBlob:function(){},saveAsBuffer:function(){},drawRect:function(t,r){var a;r||(r="RGB");var e=(r||"").replace("R","0").replace("G","1").replace("B","2"),n=[e.indexOf("0")>-1,e.indexOf("1")>-1,e.indexOf("2")>-1];(a=document.getElementById("imgRect"))||(a=document.createElement("canvas"),a.id="imgRect",document.body.appendChild(a),a.width=parseInt(this.canvas.width),a.height=parseInt(this.canvas.height));var i=a.getContext("2d");i.clearRect(0,0,a.width,a.height);var o=[[],[],[]];this.complileLayers();var s=this.tempPsLib.imgData.data,h=this.tempPsLib.imgData.width,c=this.tempPsLib.imgData.height;if(e)for(var u=0;c>u;u++)for(var f=0;h>f;f++)for(var d=u*h+f,l=4*d,v=0;3>v;v++)n[v]&&(o[v][s[l+v]]?o[v][s[l+v]]++:o[v][s[l+v]]=1);else for(var d=0,g=s.length;g>d;d++)o[s[d]]?o[s[d]]++:o[s[d]]=1;var p=function(t,r){i.beginPath(),i.moveTo(0,a.height);for(var e=0,n=0;255>n;n++)t[n]>e&&(e=t[n]);for(var n=0;255>n;n++){var o=t[n]||0;o=a.height-o/e*.8*a.height,i.lineTo(n/256*a.width,o)}i.lineTo(a.width+10,a.height),i.closePath(),i.fillStyle=r,i.fill()};if(e)for(var w=["red","green","blue"],d=0;d<o.length;d++)o[d].length&&p(o[d],w[d]);else p(o,"black")},ps:function(t){if("原图"==t||"origin"==t||""==t)return this;var r=e.reflectEasy(t),a=r.call(this,this.canvas);return a},logTime:function(t){},ctx:function(t){var r=this.ctxContext;return r.putImageData(this.imgData,0,0),t.call(r),this.imgData=r.getImageData(0,0,this.canvas.width,this.canvas.height),this},notify:function(t){"readyStateOK"==t&&(this.readyState=1)},complete:function(t){this.useWorker?this.dorsyWorker.queue.push(["complete",t]):t()},transform:function(r,a,e){var n=window[t].dorsyMath(),i=this.ctxContext;i.putImageData(this.imgData,0,0);for(var o=document.createElement("canvas").getContext("2d"),s=[new n.Matrix([0,0],"1*2"),new n.Matrix([0,this.canvas.height],"1*2"),new n.Matrix([this.canvas.width,0],"1 * 2"),new n.Matrix([this.canvas.width,this.canvas.height],"1*2")],h=[],c=new n.Matrix(r,"2*2"),u=0;u<s.length;u++)h.push(s[u].mutiply(c));var f=Math.max(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),d=Math.min(h[0].data[0][0],h[1].data[0][0],h[2].data[0][0],h[3].data[0][0]),l=Math.max(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),v=Math.min(h[0].data[0][1],h[1].data[0][1],h[2].data[0][1],h[3].data[0][1]),g=~~(f-d),p=~~(l-v);o.canvas.width=g,o.canvas.height=p,o.translate(-d,-v),o.transform.apply(o,r),o.drawImage(i.canvas,0,0),this.canvas.width=g,this.canvas.height=p,this.width=g,this.height=p,this.imgData=o.getImageData(0,0,g,p);for(var u=this.layers.length-1;u>-1;u--){var w=this.layers[u];(2===w[0].type||1===w[0].type)&&w[0].transform(r,a,e)}return this},scale:function(t,r){var r=r||t;return this.transform([t,0,0,r,0,0])},scaleTo:function(t,r){var a,e,n=this.width,i=this.height;r||(r=t*i/n),t||(t=r*(n/i));return t&&r?(a=t/n,e=r/i,this.scale(a,e)):void 0},rotate:function(t){var r=t/180*Math.PI,a=[Math.cos(r),Math.sin(r),-Math.sin(r),Math.cos(r),0,0];return this.transform(a)},moveTo:function(t,r){return t=t||0,r=r||0,this.transform([1,0,0,1,t,r])},clip:function(t,r,a,e){return this.ctxContext.putImageData(this.imgData,0,0),this.imgData=this.ctxContext.getImageData(t,r,a,e),this.context.canvas.width=a,this.context.canvas.height=e,this},Tools:function(t){return e.tools(this.imgData,arguments)}}}("psLib"),window.AlloyImage=window.$AI=window.psLib,function(t){window[t].module("addLayer",function(t){var r={add:function(t,r,a,e,n,i,o,s){var h=t.data,c=r.data,n=n||0,i=i||0,e=e||1,s=s||"RGB";/[RGB]+/.test(s)||(s="RGB");var u,f,d=s.replace("R","0").replace("G","1").replace("B","2"),l=t.width,v=t.height,g=(c.length,r.width),p=r.height,w=[d.indexOf("0")>-1,d.indexOf("1")>-1,d.indexOf("2")>-1],m=n,y=n+g,M=i,b=i+p;if(!(m>l||(0>m&&(m=0),0>y||(y>l&&(y=l),M>v||(0>M&&(M=0),0>b))))){b>v&&(b=v);for(var I,x,k,R=M;b>R;R++){I=R*l,x=R-i,k=x*g;for(var L=m;y>L;L++)for(var C=L-n,G=4*(I+L),f=4*(k+C),D=0;3>D&&0!=c[f+3];D++)switch(h[G+3]=c[f+3],a){case"颜色减淡":w[D]&&(u=h[G+D]+h[G+D]*c[f+D]/(255-c[f+D]),h[G+D]=(1-e)*h[G+D]+e*u);break;case"变暗":w[D]&&(u=h[G+D]<c[f+D]?h[G+D]:c[f+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"变亮":w[D]&&(u=h[G+D]>c[f+D]?h[G+D]:c[f+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"正片叠底":w[D]&&(u=~~(h[G+D]*c[f+D]/255),h[G+D]=(1-e)*h[G+D]+e*u);break;case"滤色":w[D]&&(u=~~(255-(255-h[G+D])*(255-c[f+D])/255),h[G+D]=(1-e)*h[G+D]+e*u);break;case"叠加":w[D]&&(u=h[G+D]<=127.5?h[G+D]*c[f+D]/127.5:255-(255-h[G+D])*(255-c[f+D])/127.5,h[G+D]=(1-e)*h[G+D]+e*u);break;case"强光":w[D]&&(u=c[f+D]<=127.5?h[G+D]*c[f+D]/127.5:h[G+D]+(255-h[G+D])*(c[f+D]-127.5)/127.5,h[G+D]=(1-e)*h[G+D]+e*u);break;case"差值":w[D]&&(u=h[G+D]>c[f+D]?h[G+D]-c[f+D]:c[f+D]-h[G+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"排除":w[D]&&(u=h[G+D]+c[f+D]-h[G+D]*c[f+D]/127.5,h[G+D]=(1-e)*h[G+D]+e*u);break;case"点光":w[D]&&(u=h[G+D]<2*c[f+D]-255?2*c[f+D]-255:h[G+D]<2*c[f+D]?h[G+D]:2*c[f+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"颜色加深":w[D]&&(u=255-255*(255-h[G+D])/c[f+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"线性加深":if(w[D]){var S=h[G+D]+c[f+D];u=S>255?S-255:0,h[G+D]=(1-e)*h[G+D]+e*u}break;case"线性减淡":if(w[D]){var S=h[G+D]+c[f+D];u=S>255?255:S,h[G+D]=(1-e)*h[G+D]+e*u}break;case"柔光":w[D]&&(u=c[f+D]<127.5?((2*c[f+D]-255)*(255-h[G+D])/65025+1)*h[G+D]:(2*c[f+D]-255)*(Math.sqrt(h[G+D]/255)-h[G+D]/255)+h[G+D],h[G+D]=(1-e)*h[G+D]+e*u);break;case"亮光":w[D]&&(u=c[f+D]<127.5?255*(1-(255-h[G+D])/(2*c[f+D])):h[G+D]/(2*(1-c[f+D]/255)),h[G+D]=(1-e)*h[G+D]+e*u);break;case"线性光":if(w[D]){var S=h[G+D]+2*c[f+D]-255;u=S>255?255:S,h[G+D]=(1-e)*h[G+D]+e*u}break;case"实色混合":w[D]&&(u=c[f+D]<255-h[G+D]?0:255,h[G+D]=(1-e)*h[G+D]+e*u);break;default:w[D]&&(u=c[f+D],h[G+D]=(1-e)*h[G+D]+e*u)}}return t}}};return r})}("psLib"),function(t){window[t].module("applyMatrix",function(t){var r={process:function(r,a){for(var e=r.data,n=r.width,i=(r.height,new t.lib.dorsyMath.Matrix([-2,-4,-4,-4,-2,-4,0,8,0,-4,-4,8,24,8,-4,-4,0,8,0,-4,-2,-4,-4,-4,-2],25,1)),o=[],s=0,h=e.length;h>s;s+=4){var c=s/4,u=parseInt(c/n),f=c%n;if(0!=u&&0!=f){for(var d=[[],[],[]],l=-2;3>l;l++)for(var v=u+l,g=-2;3>g;g++)for(var p=f+g,w=4*(v*n+p),m=0;3>m;m++){var y=w+m;d[m].push(e[y])}for(var M=new t.lib.dorsyMath.Matrix(d,3,matrixSize),b=M.mutiply(i),m=0;3>m;m++)o[s+m]=b.data[m];o[s+4]=e[s+4]}}for(var s=0,h=e.length;h>s;s++)e[s]=o[s]||e[s];return r}};return r})}("psLib"),function(t){window[t].module("config",function(t){var r={Alteration:{"亮度":"brightness","色相/饱和度调节":"setHSI","曲线":"curve","gamma调节":"gamma","可选颜色":"selectiveColor"},Filter:{"灰度处理":"toGray","反色":"toReverse","灰度阈值":"toThresh","高斯模糊":"gaussBlur","浮雕效果":"embossment","查找边缘":"borderline","马赛克":"mosaic","油画":"oilPainting","腐蚀":"corrode","锐化":"sharp","添加杂色":"noise","暗角":"darkCorner","喷点":"dotted","降噪":"denoise","棕褐色":"sepia","色调分离":"posterize"},ComEffect:{"美肤":"softenFace","素描":"sketch","自然增强":"softEnhancement","紫调":"purpleStyle","柔焦":"soften","复古":"vintage","黑白":"gray","仿lomo":"lomo","亮白增强":"strongEnhancement","灰白":"strongGray","灰色":"lightGray","暖秋":"warmAutumn","木雕":"carveStyle","粗糙":"rough"}},a=function(){var t={};for(var a in r)if("ComEffect"!=a)for(var e in r[a])t[e]=a,t[r[a][e]]=a;return t}(),e={getModuleName:function(t){var e;if(e=a[t]){var n=r[e][t]||t;return{spaceName:e,actName:n}}throw new Error("AI_ERROR:调用AI不存在的方法"+t)},getEasyFun:function(t){return{spaceName:"ComEffect",actName:r.ComEffect[t]||t}},getConfig:function(){return r}};return e})}("psLib"),function(t){window[t].module("dorsyMath",function(t){var r={FFT1:function(t){function a(){i++;for(var t=n/Math.pow(2,i),r=n/t,o=0;t>o;o++)e(o*r,(o+1)*r-1,i);t>1&&a()}function e(a,e,i){for(var s=Math.pow(2,i-1),h=a,c=0;e-s>=h;h++){var u=h+s,f=c*n/Math.pow(2,i),d=f+n/4;t[h]instanceof r.C||(t[h]=new r.C(t[h])),t[u]instanceof r.C||(t[u]=new r.C(t[u]));var l=t[h].plus(t[u].mutiply(o[f])),v=t[h].plus(t[u].mutiply(o[d]));t[h]=l,t[u]=v,c++}}for(var n=t.length,i=0,o=[],s=0;n>s;s++)o[s]=this.exp(-2*Math.PI*s/n);return a(),t},DFT:function(){},Matrix:function(t,r,a){var e=[];if(r){if(isNaN(r))var n=/(\d+)\s*\*/.exec(r)[1],i=/\*\s*(\d+)/.exec(r)[1];else n=r,i=a;if(t[0]&&t[0][0])for(var o=0;n>o;o++){e[o]=[];for(var s=0;i>s;s++)e[o][s]=t[o][s]||0}else for(var o=0;n>o;o++){e[o]=[];for(var s=0;i>s;s++){e[o][s]=t[o*i+s]||0}}this.m=n,this.n=i}else this.m=t.length,this.n=t[0].length;this.data=e},C:function(t,r){this.r=t||0,this.i=r||0},exp:function(t,a){t=t||0,a=a||1;var e=new r.C;return e.r=a*Math.cos(t),e.i=a*Math.sin(t),e},lagrange:function(t,r){function a(r,a){for(var n=1,i=1,o=0;e>o;o++)o!=a&&(n*=t[a]-t[o],i*=r-t[o]);var s=i/n;return s}var e=t.length,n=function(t){for(var n=0,i=0;e>i;i++){var o=a(t,i);n+=r[i]*o}return n};return n},applyMatrix:function(a,e,n){n=n||0;for(var i=a.data,o=a.width,s=(a.height,e.length),h=new r.Matrix(e,s,1),c=[],u=-(Math.sqrt(s)-1)/2,f=0,d=i.length;d>f;f+=4){var l=f/4,v=parseInt(l/o),g=l%o;if(0!=v&&0!=g){for(var p=[[],[],[]],w=u;-u>=w;w++)for(var m=v+w,y=u;-u>=y;y++)for(var M=g+y,b=4*(m*o+M),I=0;3>I;I++){var x=b+I;p[I].push(i[x])}for(var k=new t.lib.dorsyMath.Matrix(p,3,s),R=k.mutiply(h),I=0;3>I;I++)c[f+I]=R.data[I];c[f+4]=i[f+4]}}for(var f=0,d=i.length;d>f;f++)c[f]&&(i[f]=c[f]<n?c[f]:i[f]);return a},RGBToHSI:function(t,r,a){var e=(t-r+t-a)/2/Math.sqrt((t-r)*(t-r)+(t-a)*(r-a))||0;e=Math.acos(e);var n=a>r?2*Math.PI-e:e;if(t+r+a>0)var i=1-3*Math.min(t,r,a)/(t+r+a);else var i=0;var o=(t+r+a)/3;return n>2*Math.PI&&(n=2*Math.PI),0>n&&(n=0),{H:n,S:i,I:o}},HSIToRGB:function(t,r,a){if(0>t?(t%=2*Math.PI,t+=2*Math.PI):t%=2*Math.PI,t<=2*Math.PI/3)var e=a*(1-r),n=a*(1+r*Math.cos(t)/Math.cos(Math.PI/3-t)),i=3*a-(n+e);else if(t<=4*Math.PI/3){t-=2*Math.PI/3;var n=a*(1-r),i=a*(1+r*Math.cos(t)/Math.cos(Math.PI/3-t)),e=3*a-(i+n)}else{t-=4*Math.PI/3;var i=a*(1-r),e=a*(1+r*Math.cos(t)/Math.cos(Math.PI/3-t)),n=3*a-(i+e)}return{R:n,G:i,B:e}},applyInHSI:function(t,r){for(var a=["R","Y","G","C","B","M"],e=t.data,n=Math.PI/6,i=Math.PI/3,o=0,s=e.length;s>o;o+=4){var h=this.RGBToHSI(e[o],e[o+1],e[o+2]),c=h.H+n,u=~~(c/i),f=a[u%6];r(h,f,e[o+3]),h.S>1&&(h.S=1),h.S<0&&(h.S=0);var d=this.HSIToRGB(h.H,h.S,h.I);e[o]=d.R,e[o+1]=d.G,e[o+2]=d.B}},applyInCoordinate:function(t,r){},distance:function(t,a){a=a||[0,0],t=new r.C(t[0],t[1]),a=new r.C(a[0],a[1]);var e=t.minus(a);return e.distance()},xyToIFun:function(t){return function(r,a,e){return e=e||0,4*(a*t+r)+e}},xyCal:function(t,r,a,e,n){var i=this.xyToIFun(t.width),o=i(r,a,0),s=t.data,h=e(s[o],s[o+1],s[o+2]);h&&(s[o]=h[0],s[o+1]=h[1],s[o+2]=h[2]),n&&(s[o+3]=n(s[o+3]))}};return r.Matrix.prototype={plus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵加法行列不匹配");for(var a=new r.Matrix([],this.m,this.n),e=0;e<this.m;e++)for(var n=0;n<this.n;n++)a.data[e][n]=this.data[e][n]+t.data[e][n];return a},minus:function(t){if(this.m!=t.m||this.n!=t.n)throw new Error("矩阵减法法行列不匹配");for(var a=new r.Matrix([],this.m,this.n),e=0;e<this.m;e++)for(var n=0;n<this.n;n++)a.data[e][n]=this.data[e][n]-t.data[e][n];return a},mutiply:function(t){if(this.n!=t.m)throw new Error("矩阵乘法行列不匹配");for(var a=new r.Matrix([],this.m,t.n),e=0;e<this.m;e++)for(var n=0;n<t.n;n++){for(var i=0,o=0;o<this.n;o++)i+=this.data[e][o]*t.data[o][n];a.data[e][n]=i}return a}},r.C.prototype={plus:function(t){var a=new r.C;return a.r=this.r+t.r,a.i=this.i+t.i,a},minus:function(t){var a=new r.C;return a.r=this.r-t.r,a.i=this.i-t.i,a},mutiply:function(t){var a=new r.C;return a.r=this.r*t.r-this.i*t.i,a.i=this.r*t.i+this.i*t.r,a},divide:function(t){var a=new r.C,e=t.mutiply(t.conjugated()),n=this.mutiply(t.conjugated());return a.r=n.r/e.r,a.i=n.i/e.r,a},conjugated:function(){var t=new r.C(this.r,-this.i);return t},distance:function(){return Math.sqrt(this.r*this.r+this.i*this.i)}},r})}("psLib"),function(t){window[t].module("dorsyWorker",function(t){var r=200,a=function(a){var e=new Worker(t.path);if(!e)throw new Error("使用worker时，alloyimage文件目录指定出错");var n={queue:[],startWorker:function(){this.shiftAction()},shiftAction:function(){function t(){if(n[1].readyState){var i=[a.imgData,n[1].imgData].concat(n.slice(2));e.postMessage(["add",i])}else setTimeout(function(){t()},r)}var n=this.queue.shift(),i=this;if(!n)return void setTimeout(function(){n=i.queue.shift(),n||a.notify("readyStateOK")},r);var o=n[0];"act"==o?e.postMessage(["act",n[1],a.imgData,n[2]]):"add"==o?t():"show"==o?(a.show(n[1],n[2],1),this.shiftAction()):"complete"==o?(n[1]&&n[1](),this.shiftAction()):"clone"==o?(a.clone(1),this.shiftAction()):"save"==o?(a.save(0,1),this.shiftAction()):"replace"==o&&(a.replace(n[1],1),this.shiftAction())},callback:function(t){a.imgData=t,this.shiftAction()}};return e.onmessage=function(t){n.callback(t.data)},n};return a})}("psLib"),function(t){window[t].module("easy",function(r){var a={getFun:function(r){var a={softenFace:function(){var t=this.clone();return t.add(this.act("高斯模糊",10),"滤色").act("亮度",-10,5)},sketch:function(){var t=this.clone();return this.add(t.act("反色").act("高斯模糊",8),"颜色减淡").act("toGray").act("锐化",1)},softEnhancement:function(){return this.act("曲线",[0,190,255],[0,229,255])},purpleStyle:function(){var t=this.clone();return this.add(t.act("高斯模糊",3),"正片叠底","RG")},soften:function(){var t=this.clone();return this.add(t.act("高斯模糊",6),"变暗")},vintage:function(){this.clone();return this.act("灰度处理").add(window[t](this.canvas.width,this.canvas.height,"#808080").act("添加杂色").act("高斯模糊",4).act("色相/饱和度调节",32,19,0,!0),"叠加")},gray:function(){return this.act("灰度处理")},lomo:function(){var t=this.clone().add(this.clone(),"滤色").add(this.clone(),"柔光");return t.add(this.clone().act("反色"),"正常","20%","B").act("暗角",6,200)},strongEnhancement:function(){return this.clone().add(this.clone().act("曲线",[0,50,255],[0,234,255]),"柔光")},strongGray:function(){return this.act("灰度处理").act("曲线",[0,61,69,212,255],[0,111,176,237,255])},lightGray:function(){return this.act("灰度处理").act("曲线",[0,60,142,194,255],[0,194,240,247,255])},warmAutumn:function(){var t=this.clone().act("色相/饱和度调节",36,47,8,!0).act("暗角",6,150);return this.add(t,"叠加")},carveStyle:function(){var t=this.clone().act("马赛克").act("查找边缘").act("浮雕效果");return this.add(t,"线性光")},rough:function(){return this.add(window[t](this.canvas.width,this.canvas.height,"#000").act("喷点").act("反色").act("浮雕效果"),"叠加")}};return a[r]}};return a})}("psLib"),function(t){window[t].module("Fix",function(t){function r(t){var r=(t.naturalWidth,t.naturalHeight),a=document.createElement("canvas");a.width=1,a.height=r;var e=a.getContext("2d");e.drawImage(t,0,0);for(var n=e.getImageData(0,0,1,r).data,i=0,o=r,s=r;s>i;){var h=n[4*(s-1)+3];0===h?o=s:i=s,s=o+i>>1}var c=s/r;return 0===c?1:c}function a(t,a,e,n,i,o,s,h,c,u){var f=r(a);t.drawImage(a,e*f,n*f,i*f,o*f,s,h,c,u)}function e(t,r,e,n){var i=0,o=0,s=r.width,h=r.height,c=0,u=0;a(t,r,i,o,s,h,c,u,e,n)}var n={drawImageIOS:e,drawImageIOSFix:a};return n})}("psLib"),function(t){window[t].module("Tools",function(t){var r={getColor:{process:function(r,a){var e,n,i=t.lib.dorsyMath,o=(i.xyToIFun(r.width),50),s=2*Math.PI/o,h=[];i.applyInHSI(r,function(t,r,a){a>128&&(n=parseInt(t.H/s),h[n]||(h[n]=[]),h[n].push([t.S,t.I]))});for(var c=0,u=0,e=0;o>e;e++)h[e]&&h[e].length>c&&(c=h[e].length,u=e);for(var f,d,l=0,v=0,e=0;e<h[u].length;e++)l+=h[u][e][0],v+=h[u][e][1];f=l/h[u].length,d=v/h[u].length;var g=u*s,p=i.HSIToRGB(g,f,d),w="rgb("+parseInt(p.R)+","+parseInt(p.G)+","+parseInt(p.B)+")";return w}},toText:{process:function(r,a){var e,n=r.data,i=r.width,o=r.height,s=a[0]||".:;!#@",h="";console.log(s);for(var c,u,f=t.lib.dorsyMath,d=f.xyToIFun(r.width),l=255/s.length,v=0;i>v;v+=1){for(var g=0;o>g;g+=1)c=d(v,g,0),e=(n[c]+n[c+1]+n[c+2])/3,u=parseInt(e/l),h+=s[u];h+="<br />"}return h}}};return r})}("psLib"),function(t){window[t].module("Filter.ImageEnhance",function(t){var r={process:function(t,r,a){for(var e=(arg||.5,t.data),n=(t.width,t.height,0),i=e.length;i>n;n+=4);return t.data=e,t}};return r})}("psLib"),function(t){window[t].module("Filter.corrode",function(t){var r={process:function(t,r){for(var a=parseInt(r[0])||3,e=t.data,n=t.width,i=t.height,o=0;n>o;o++)for(var s=0;i>s;s++)for(var h=parseInt(Math.random()*a*2)-a,c=parseInt(Math.random()*a*2)-a,u=s*n+o,f=(s+h)*n+o+c,d=0;3>d;d++)e[4*u+d]=e[4*f+d];return t}};return r})}("psLib"),function(t){window[t].module("Filter.darkCorner",function(t){var r={process:function(r,a){function e(r,a,e){var n=t.lib.dorsyMath.distance([r,a],[c,u]),o=(n-d)/(f-d);return 0>o&&(o=0),l(o,0,.02,.3,1)*e*i/255}for(var n=parseInt(a[0])||3,i=(a[2]||"round",a[1]||30),o=r.data,s=r.width,h=r.height,c=2*s/3,u=1*h/2,f=t.lib.dorsyMath.distance([c,u]),d=f*(1-n/10),l=function(t,r,a,e,n){return r*Math.pow(1-t,3)+3*a*t*Math.pow(1-t,2)+3*e*t*t*(1-t)+n*Math.pow(t,3)},v=0;s>v;v++)for(var g=0;h>g;g++)for(var p=g*s+v,w=0;3>w;w++){var m=e(v,g,o[4*p+w]);o[4*p+w]-=m}return r}};return r})}("psLib"),function(t){window[t].module("Filter.dotted",function(t){var r={process:function(r,a){for(var e=parseInt(a[0])||1,n=parseInt(a[1])||1,i=r.data,o=r.width,s=r.height,h=2*e+1,c=[],u=n*n,f=-e;e>f;f++)for(var d=-e;e>d;d++)f*f+d*d>u&&c.push([f,d]);for(var l=t.lib.dorsyMath.xyToIFun(o),f=0,v=parseInt(o/h);v>f;f++)for(var d=0,g=parseInt(s/h);g>d;d++)for(var p=parseInt((f+.5)*h),w=parseInt((d+.5)*h),m=0;m<c.length;m++){var y=p+c[m][0],M=w+c[m][1];i[l(y,M,3)]=225,i[l(y,M,2)]=225,i[l(y,M,0)]=225,i[l(y,M,1)]=225}return r}};return r})}("psLib"),function(t){window[t].module("Filter.embossment",function(t){var r={process:function(t,r){for(var a=t.data,e=t.width,n=(t.height,[]),i=0,o=a.length;o>i;i+=4){var s=i/4,h=parseInt(s/e),c=s%e,u=4*((h-1)*e+(c-1)),f=(h+1)*e*4+4*(c+1);if(0!=h&&0!=c){for(var d=0;3>d;d++)n[i+d]=a[u+d]-a[f+d]+127.5;n[i+4]=a[i+4]}}for(var i=0,o=a.length;o>i;i++)a[i]=n[i]||a[i];return t}};return r})}("psLib"),function(t){window[t].module("Filter.gaussBlur",function(t){var r={process:function(t,r){var a,e,n,i,o,s,h,c,u,f,d=t.data,l=t.width,v=t.height,g=[],p=0,w=r[0],m=r[1];for(w=Math.floor(w)||3,m=m||w/3,s=1/(Math.sqrt(2*Math.PI)*m),o=-1/(2*m*m),h=0,a=-w;w>=a;a++,h++)i=s*Math.exp(o*a*a),g[h]=i,p+=i;for(h=0,f=g.length;f>h;h++)g[h]/=p;for(e=0;v>e;e++)for(a=0;l>a;a++){for(n=i=o=s=0,p=0,c=-w;w>=c;c++)u=a+c,u>=0&&l>u&&(h=4*(e*l+u),n+=d[h]*g[c+w],i+=d[h+1]*g[c+w],o+=d[h+2]*g[c+w],p+=g[c+w]);h=4*(e*l+a),d[h]=n/p,d[h+1]=i/p,d[h+2]=o/p}for(a=0;l>a;a++)for(e=0;v>e;e++){for(n=i=o=s=0,p=0,c=-w;w>=c;c++)u=e+c,u>=0&&v>u&&(h=4*(u*l+a),n+=d[h]*g[c+w],i+=d[h+1]*g[c+w],o+=d[h+2]*g[c+w],p+=g[c+w]);h=4*(e*l+a),d[h]=n/p,d[h+1]=i/p,d[h+2]=o/p}return t.data=d,t}};return r})}("psLib"),function(t){window[t].module("Filter.borderline",function(t){var r={process:function(r,a){var e=[0,1,0,1,-4,1,0,1,0];return t.lib.dorsyMath.applyMatrix(r,e,250)}};return r})}("psLib"),function(t){window[t].module("Filter.mosaic",function(t){var r={process:function(t,r){for(var a=parseInt(r[0])||3,e=t.data,n=t.width,i=t.height,o=2*a+1,s=0,h=parseInt(n/o);h>s;s++)for(var c=0,u=parseInt(i/o);u>c;c++){for(var f=[],d=[0,0,0],l=0;o>l;l++)for(var v=0;o>v;v++){var g=(c*o+l)*n+s*o+v;d[0]+=e[4*g],d[1]+=e[4*g+1],d[2]+=e[4*g+2]}f[0]=d[0]/(o*o),f[1]=d[1]/(o*o),f[2]=d[2]/(o*o);for(var l=0;o>l;l++)for(var v=0;o>v;v++){var g=(c*o+l)*n+s*o+v;e[4*g]=f[0],e[4*g+1]=f[1],e[4*g+2]=f[2]}}return t}};return r})}("psLib"),function(t){window[t].module("Filter.noise",function(t){var r={process:function(t,r){for(var a=parseInt(r[0])||100,e=t.data,n=t.width,i=t.height,o=0;n>o;o++)for(var s=0;i>s;s++)for(var h=s*n+o,c=0;3>c;c++){var u=parseInt(Math.random()*a*2)-a;e[4*h+c]+=u}return t}};return r})}("psLib"),function(t){window[t].module("Filter.oilPainting",function(t){var r={process:function(t,r){for(var a=parseInt(r[0])||16,e=t.data,n=t.width,i=t.height,o=0;n>o;o++)for(var s=0;i>s;s++){for(var h=s*n+o,c=0,u=0;3>u;u++)c+=e[4*h+u];c/=3;for(var f=parseInt(c/a)*a,u=0;3>u;u++)e[4*h+u]=f}return t}};return r})}("psLib"),function(t){window[t].module("Filter.posterize",function(t){var r={process:function(r,a){var e=t.lib.dorsyMath,n=(r.data,r.width),i=r.height,o=a[0]||20;o=1>o?1:o>255?255:o;for(var s=Math.floor(255/o),h=0;n>h;h++)for(var c=0;i>c;c++)e.xyCal(r,h,c,function(t,r,a){return[Math.floor(t/s)*s,Math.floor(r/s)*s,Math.floor(a/s)*s]});return r}};return r})}("psLib"),function(t){window[t].module("Filter.sepia",function(t){var r={process:function(r){for(var a=t.lib.dorsyMath,e=(r.data,r.width),n=r.height,i=0;e>i;i++)for(var o=0;n>o;o++)a.xyCal(r,i,o,function(t,r,a){return[.393*t+.769*r+.189*a,.349*t+.686*r+.168*a,.272*t+.534*r+.131*a]});return r}};return r})}("psLib"),function(t){window[t].module("Filter.sharp",function(t){var r={process:function(t,r){for(var a=r[0]||.6,e=t.data,n=t.width,i=(t.height,0),o=e.length;o>i;i+=4){var s=i/4,h=parseInt(s/n),c=s%n;if(0!=h&&0!=c)for(var u=4*((h-1)*n+(c-1)),f=4*((h-1)*n+c),d=4*(s-1),l=0;3>l;l++){var v=e[i+l]-(e[f+l]+e[d+l]+e[u+l])/3;e[i+l]+=v*a}}return t}};return r})}("psLib"),function(t){window[t].module("Filter.toGray",function(t){var r={process:function(t){for(var r=t.data,a=0,e=r.length;e>a;a+=4){var n=parseInt(.299*r[a]+.578*r[a+1]+.114*r[a+2]);r[a+2]=r[a+1]=r[a]=n}return t.data=r,t}};return r})}("psLib"),function(t){window[t].module("Filter.toReverse",function(t){var r={process:function(t){for(var r=t.data,a=0,e=r.length;e>a;a+=4)r[a]=255-r[a],r[a+1]=255-r[a+1],r[a+2]=255-r[a+2];return t.data=r,t}};return r})}("psLib"),function(t){window[t].module("Filter.toThresh",function(t){var r={process:function(r,a){r=t.reflect("toGray",r);for(var e=r.data,a=a[0]||128,n=0,i=e.length;i>n;n++)(n+1)%4&&(e[n]=e[n]>a?255:0);return r.data=e,r}};return r})}("psLib"),function(t){window[t].module("Alteration.brightness",function(t){var r={process:function(t,r){for(var a=t.data,e=r[0]/50,n=r[1]||0,i=n/50,o=Math.tan((45+44*i)*Math.PI/180),s=0,h=a.length;h>s;s+=4)for(var c=0;3>c;c++)a[s+c]=(a[s+c]-127.5*(1-e))*o+127.5*(1+e);return t}};return r})}("psLib"),function(t){window[t].module("Alteration.curve",function(t){var r={process:function(r,a){var e=t.lib.dorsyMath.lagrange(a[0],a[1]),n=r.data,i=r.width,o=r.height,s=a[2];/[RGB]+/.test(s)||(s="RGB");for(var h=s.replace("R","0").replace("G","1").replace("B","2"),c=[h.indexOf("0")>-1,h.indexOf("1")>-1,h.indexOf("2")>-1],u=0;i>u;u++)for(var f=0;o>f;f++)for(var d=f*i+u,l=0;3>l;l++)c[l]&&(n[4*d+l]=e(n[4*d+l]));return r}};return r})}("psLib"),function(t){window[t].module("Alteration.gamma",function(t){var r={process:function(r,a){var e,n=t.lib.dorsyMath,i=(r.data,r.width),o=r.height;e=void 0==a[0]?10:a[0];for(var s=(e+100)/200*2,h=0;i>h;h++)for(var c=0;o>c;c++)n.xyCal(r,h,c,function(t,r,a){return[Math.pow(t,s),Math.pow(r,s),Math.pow(a,s)]});return r}};return r})}("psLib"),function(t){window[t].module("Alteration.selectiveColor",function(t){var r={process:function(r,a){for(var e=a[0],n=a[1],i=a[2],o=a[3],s=a[4],h=a[5]||0,c={red:"R",green:"G",blue:"B","红色":"R","绿色":"G","蓝色":"B"},u={cyan:"R",magenta:"G",yellow:"B","青色":"R","洋红":"G","黄色":"B"},f=function(t){return c[e]?Math.max(t.R,t.G,t.B)==t[c[e]]:u[e]?Math.min(t.R,t.G,t.B)==t[u[e]]:"black"==e||"黑色"==e?Math.min(t.R,t.G,t.B)<128:"white"==e||"白色"==e?Math.max(t.R,t.G,t.B)>128:"中性色"==e?!(Math.max(t.R,t.G,t.B)<1||Math.min(t.R,t.G,t.B)>224):void 0},d=0,l=[n,i,o,s],v=0,g=r.width;g>v;v++)for(var p=0,w=r.height;w>p;p++)t.lib.dorsyMath.xyCal(r,v,p,function(t,r,a){var n={R:t,G:r,B:a},i=[t,r,a],o=[];if(f(n)){if(c[e]){var v=c[e],g=t+r+a-Math.max(t,r,a)-Math.min(t,r,a);d=n[v]-g}else if(u[e]){var p=u[e],g=t+r+a-Math.max(t,r,a)-Math.min(t,r,a);d=g-n[p]}else if("black"==e||"黑色"==e)d=2*parseInt(127.5-Math.max(t,r,a));else if("white"==e||"白色"==e)d=2*parseInt(Math.min(t,r,a)-127.5);else{if("中性色"!=e)return;d=255-(Math.abs(Math.max(t,r,a)-127.5)+Math.abs(Math.min(t,r,a)-127.5))}for(var w=0;3>w;w++){var m=parseInt(d*(i[w]/255)),y=i[w]-m,M=parseInt(d*(1-i[w]/255)),b=i[w]+M,I=l[w]+s+l[w]*s;if(h){if(i[w]>128&&(m=M),s>0)var x=i[w]-s*m;else var x=i[w]-s*M;x>b&&(x=b),y>x&&(x=y),M=b-x,m=x-y,0>s&&(m=M),x-=l[w]>0?l[w]*m:l[w]*M}else var x=d*-I+i[w];x>b&&(x=b),y>x&&(x=y),o[w]=x}return o}});return r}};return r})}("psLib"),function(t){window[t].module("Alteration.setHSI",function(t){var r={process:function(r,a){a[0]=a[0]/180*Math.PI,a[1]=a[1]/100||0,a[2]=a[2]/100*255||0,a[3]=a[3]||!1;var e=a[4];/[RGBCMY]+/.test(e)||(e="RGBCMY");for(var n=e.split(""),i={},o=0;o<n.length;o++)i[n[o]]=1;return t.lib.dorsyMath.applyInHSI(r,function(t,r){i[r]&&(a[3]?(t.H=a[0],
t.S=a[1],t.I+=a[2]):(t.H+=a[0],t.S+=a[1],t.I+=a[2]))}),r}};return r})}("psLib");